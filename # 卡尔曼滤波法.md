# 卡尔曼滤波法

## a) 算法实测

直接获得的欧拉角信息直接用来进行姿态控制的稳定性较差，本项目使用卡尔曼滤波法来对传感器获得的欧拉角进行滤波。通过在仿真环境中进行测试，再通过TCP协议使得仿真环境与传感器进行通信，再将数据通过绘图工具实时查看传感器滤波前后的波形对比，如下图所示：

![图 1](media/image6.jpeg)

这里用俯仰角（$\theta$）作为滤波效果示例，图上的横轴代表时间，纵轴代表传感器传来的俯仰角数据，而圆点表示滤波处理过后的俯仰角，虚线表示滤波处理前的俯仰角。

可以很明显的观察到，滤波后的波形比滤波前的波形要更加圆滑，过渡更加自然，且幅度更低。在图像后半部分，机器狗正处于爬坡状态，可以看到在爬坡过程中滤波后的机器人的俯仰角变化更加平稳。我们经过仿真测试后，四足机器狗能适应更陡的坡度，它的适应能力在加入滤波算法后得到较大提高。

## b) 原理

### 1. 状态预测

$$
\hat{x}_k^- = A \hat{x}_{k-1} + B u_{k-1} \quad (1-1)
$$

$$
P_k^- = A P_{k-1} A^T + Q \quad (1-2)
$$

### 2. 观测更新

$$
y_k = z_k - H \hat{x}_k^- \quad (2-1)
$$

$$
S_k = H P_k^- H^T + R \quad (2-2)
$$

$$
K_k = P_k^- H^T S_k^{-1} \quad (2-3)
$$

$$
\hat{x}_k = \hat{x}_k^- + K_k y_k \quad (2-4)
$$

$$
P_k = (I - K_k H) P_k^- \quad (2-5)
$$

## c) 公式解释

卡尔曼滤波器是一种递归算法，用于估计动态系统的状态，同时结合了系统的数学模型和观测数据。它的核心思想是通过预测和更新两个步骤，逐步优化状态估计值，同时考虑系统的不确定性和观测噪声。

### 1) 预测模块

- 式(1-1)中 $A$ 表示系统的状态转移矩阵，式(1-1)能根据上一时刻的状态估计值 $\hat{x}_{k-1}$ 来预测当前状态 $\hat{x}_k^-$。
- 式(1-2)中 $P_k^-$ 表示基于第 $k-1$ 步，对第 $k$ 步的预测的协方差矩阵，同时 $Q$ 表示系统的不确定性（过程噪声协方差矩阵）。
- 综合来说，式(1-1)作用是通过上一时刻的状态估计值来预测当前时刻的状态估计值，式(1-2)的作用是通过上一时刻的预测状态协方差矩阵 $P_{k-1}$ 再加入噪声协方差矩阵 $Q$ 的影响进而计算当前时刻的预测状态协方差矩阵 $P_k^-$。

### 2) 观测模块

- 式(2-1)中 $y_k$ 表示观测值 $z_k$ 与预测值 $H \hat{x}_k^-$ 的差值（$H$ 为观测矩阵，用以选择要观测的变量）。
- 式(2-2)中用 $S_k$ 来表示观测残差（观测值和预测值之间的差异），通过将预测状态协方差矩阵 $P_k^-$ 映射到观测空间（$H$）和观测噪声协方差矩阵 $R$ 来组成残差协方差矩阵。当 $S_k$ 较大时，说明观测数据对于我们估计当前状态的可信度较低，反之则观测数据可信度较高。
- 通过残差协方差矩阵我们可了解到观测数据和预测数据对于状态估计的权重，因此式（2-3）给出了一个增益值来动态调整观测数据在状态更新中的权重，即卡尔曼增益 $K_k$。
- 最后，式（2-4），（2-5）分别用来更新状态矩阵 $\hat{x}_k$ 和预测状态协方差矩阵 $P_k$。此时，一轮更新完成，接着通过不断地迭代来进行对应状态和参数的更新，而状态矩阵在本项目中即包含了我们需要的欧拉角。